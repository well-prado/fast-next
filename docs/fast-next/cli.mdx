# CLI Reference

Use the `create-fast-next` CLI to scaffold files and keep feature routes consistent across projects.

## Installation

While the package lives inside this monorepo, you can execute it via any package manager:

```bash
npx create-fast-next init .
pnpm dlx create-fast-next init .
yarn create fast-next init .
bunx create-fast-next init .
```

Once it’s published to npm, the same commands work globally. During development you can point `pnpm dlx` at the local workspace: `pnpm dlx --package=./packages/create-fast-next create-fast-next init .`.

## Commands

### `init`

```
pnpm dlx create-fast-next init [projectDir] \
  --app app \
  --server src/server \
  --api app/api/[...fastify]
```

- Creates the catch-all API route that forwards requests to Fastify.
- Sets up `src/server/fastify-app.ts`, `src/server/routes/index.ts`, and `src/server/api.ts`.
- Adds placeholder markers (`FAST_NEXT_ROUTE_IMPORTS` / `FAST_NEXT_ROUTE_SPREAD`) so future features can be appended automatically.
- Drops a starter health-check route so `/api/health` responds immediately.
- Generates a `/demo` page (`app/demo/page.tsx`), browser client (`client/api.ts`), and `ProjectsClientPanel` component so you can validate server actions + client hooks without modifying the default Next.js home page.
- Prompts for directories when flags aren’t provided (disable with `--yes`).
- Optionally updates `package.json` and installs all required dependencies when `--install auto|pnpm|npm|yarn|bun` is supplied (or when you accept the prompt).

Options:

| Flag | Description | Default |
| --- | --- | --- |
| `--app <path>` | Location of your Next.js `app` directory. | `app` |
| `--server <path>` | Directory that should hold `fastify-app.ts`, `routes`, etc. | `src/server` |
| `--api <path>` | Relative path to the catch-all API route folder. | `<app>/api/[...fastify]` |
| `--force` | Overwrite files if they already exist. | `false` |
| `--install <pm>` | Install deps with `pnpm`, `npm`, `yarn`, `bun`, `auto`, or `skip`. | Prompt in TTY / `skip` in CI |
| `--yes` | Skip interactive prompts (use defaults). | `false` |
| `--with-queue` | Include BullMQ queue scaffolding (services, queues, workers). | Prompted |
| `--with-cache <provider>` | Include cache service (`memory`, `redis`, or `upstash`). | Prompted |
| `--with-mcp` | Add MCP server, sample tool, and Fastify routes. | Prompted |
| `--with-docker` | Generate `docker-compose.yml`, `.dockerignore`, and `.env.example`. | Prompted |

When `--with-queue` is enabled, the CLI generates:

- `src/server/services/queue.service.ts` – central BullMQ registry with retry/backoff defaults.
- `src/server/queues/email.queue.ts` – example producer helper.
- `src/server/workers/email.worker.ts` + `workers/index.ts` – ready-to-run worker bootstrap.

It also adds `bullmq`/`ioredis` to your dependencies and reminds you to configure `REDIS_HOST`, `REDIS_PORT`, and `REDIS_PASSWORD`.

When `--with-cache <provider>` is supplied, the CLI drops `src/server/services/cache/cache.service.ts` with:

- A shared `CacheService` wrapper + `wrap()` helper.
- Provider implementations for memory (always) plus the requested provider (Redis with `ioredis`, or Upstash with `@upstash/redis`).
- Default `cache` instance that respects the `CACHE_PROVIDER` environment variable.

If you choose `redis` or `upstash`, the necessary dependencies are added automatically; otherwise the memory provider is ready for local testing with zero config.

When `--with-mcp` is enabled, you get:

- `src/server/services/mcp/mcp.service.ts` – lightweight MCP server wrapper + registry.
- `src/server/services/mcp/server.ts` – entrypoint (`pnpm exec tsx ...`) to run the MCP server independently.
- `src/server/features/mcp/tools/ping.tool.ts` – sample tool registration.
- `src/server/features/mcp/routes.ts` – Fastify routes that list available tools.

The CLI automatically wires the routes into `serverRoutes` and adds `@modelcontextprotocol/sdk` to your dependencies.

When `--with-docker` is passed, the CLI creates:

- `docker-compose.yml` with health-checked app, Postgres, Redis, and MCP services.
- `Dockerfile` (Next.js dev server) and `Dockerfile.mcp` (MCP server entrypoint).
- `.dockerignore` seeded with common build artifacts.
- `.env.example` describing the environment variables referenced by the compose file.
- `docker:up`, `docker:down`, and `docker:logs` scripts added to `package.json` if they’re missing.

Update `.env` and `Dockerfile` as needed before running `docker compose up`.

### `feature`

```
pnpm dlx create-fast-next feature projects --server src/server --dir .
```

- Generates a full feature folder: `schemas.ts`, `service.ts`, `routes.ts`, and a stub `routes.test.ts`.
- Route templates include both `GET /<resource>` and `POST /<resource>` handlers plus in-memory services you can replace.
- Updates `src/server/routes/index.ts` by inserting the necessary import and spreading the new routes into the master array (using the scaffold markers added during `init`).

Options:

| Flag | Description | Default |
| --- | --- | --- |
| `--dir <path>` | Project root where the server directory lives. | `.` |
| `--server <path>` | Path to the server folder relative to `dir`. | `src/server` |
| `--force` | Overwrite the feature file if it already exists. | `false` |

> Tip: run `pnpm dlx create-fast-next feature analytics` as many times as you like—your `server/routes/index.ts` file will stay tidy thanks to the FAST_NEXT markers.

### `queue`

```
pnpm dlx create-fast-next queue start --entry src/server/workers/index.ts
pnpm dlx create-fast-next queue status --server src/server --redis redis://localhost:6379
pnpm dlx create-fast-next queue generate invoices
```

- `start` (default) spawns `pnpm exec tsx <entry>` (respecting your package manager) so you can keep workers running alongside `pnpm dev`.
- `status` inspects `src/server/queues`, infers queue names, and prints BullMQ counts (waiting/active/completed/failed/delayed) by connecting to Redis. Use `--redis` to override the connection string.
- `generate <name>` scaffolds a matching queue + worker file so you can bootstrap new processors quickly.
- `--dir`, `--server`, and `--entry` mirror other commands so you can target different folders.

### `cache`

```
pnpm dlx create-fast-next cache stats --redis redis://localhost:6379
pnpm dlx create-fast-next cache clear user:123
```

- `stats` connects to Redis (env or `--redis`) and prints DB size plus memory info.
- `clear <key>` deletes a specific cache key.
- Additional providers will arrive later; for now the command focuses on Redis-compatible stores.

### `mcp`

```
pnpm dlx create-fast-next mcp start --entry src/server/services/mcp/server.ts
pnpm dlx create-fast-next mcp status
pnpm dlx create-fast-next mcp tool query-db
```

- `start` launches the MCP server entrypoint via your detected package manager.
- `status` lists every registered MCP tool by inspecting `src/server/features/mcp/tools/index.ts`.
- `tool <name>` scaffolds a new tool file and automatically adds it to the tools index so the server registers it on startup.

## Manual usage inside the monorepo

During development (before publishing) you can invoke the CLI directly:

```
pnpm dlx --package=./packages/create-fast-next create-fast-next init .
```

or

```
node packages/create-fast-next/bin/create-fast-next.mjs feature audit --server apps/web/src/server
```

The generated files match the conventions documented throughout this guide, so the server caller, browser client, and docs will continue to apply without additional tweaks.
